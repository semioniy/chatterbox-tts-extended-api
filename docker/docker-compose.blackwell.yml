version: '3.8'

name: Chatterbox-TTS-Extended-API
services:
  chatterbox-tts:
    build:
      context: ..
      dockerfile: docker/Dockerfile.blackwell
    container_name: Chatterbox-TTS
    ports:
      - '${PORT:-4123}:${PORT:-4123}'
    environment:
      - HF_HOME=/cache/hf
      - HUGGINGFACE_HUB_CACHE=/cache/hf/hub
      - TORCH_HOME=/cache/torch
      - XDG_CACHE_HOME=/cache/xdg
      
      - PORT=${PORT:-4123}
      - HOST=${HOST:-0.0.0.0}

      # TTS Model Settings
      - EXAGGERATION=${EXAGGERATION:-0.5}
      - CFG_WEIGHT=${CFG_WEIGHT:-0.5}
      - TEMPERATURE=${TEMPERATURE:-0.8}

      # Text Processing
      - MAX_CHUNK_LENGTH=${MAX_CHUNK_LENGTH:-280}
      - MAX_TOTAL_LENGTH=${MAX_TOTAL_LENGTH:-3000}

      # Voice and Model Settings
      - VOICE_SAMPLE_PATH=/app/voice-sample.mp3
      - DEVICE=${DEVICE:-cuda}
      - MODEL_CACHE_DIR=${MODEL_CACHE_DIR:-/cache}
      - VOICE_LIBRARY_DIR=${VOICE_LIBRARY_DIR:-/voices}

      # NVIDIA/CUDA settings
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      
      - MEMORY_CLEANUP_INTERVAL=${MEMORY_CLEANUP_INTERVAL:-60}
      - CUDA_CACHE_CLEAR_INTERVAL=${CUDA_CACHE_CLEAR_INTERVAL:-600}
      
      # Long text job settings (MUST be explicitly passed)
      - LONG_TEXT_DATA_DIR=${LONG_TEXT_DATA_DIR:-/data/long_text_jobs}
      - LONG_TEXT_MAX_LENGTH=${LONG_TEXT_MAX_LENGTH:-100000}
      - LONG_TEXT_CHUNK_SIZE=${LONG_TEXT_CHUNK_SIZE:-2500}
      - LONG_TEXT_SILENCE_PADDING_MS=${LONG_TEXT_SILENCE_PADDING_MS:-200}
      - LONG_TEXT_JOB_RETENTION_DAYS=${LONG_TEXT_JOB_RETENTION_DAYS:-7}
      - LONG_TEXT_MAX_CONCURRENT_JOBS=${LONG_TEXT_MAX_CONCURRENT_JOBS:-1}

    volumes:
      - ${DATA_DIR:-../data}/cache:/cache
      - ${DATA_DIR:-../data}/voices:/voices
      - ${DATA_DIR:-../data}/long_text_jobs:/data/long_text_jobs

    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

    restart: unless-stopped

#    healthcheck:
#      test: ['CMD', 'curl', '-f', 'http://localhost:${PORT:-4123}/health']
#      interval: 300s
#      timeout: 30s
#      retries: 4
#      start_period: 300s

  # Frontend Service with integrated proxy (optional - requires 'Frontend' profile)
  frontend:
    profiles: ['Frontend']
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: Chatterbox-Frontend
    ports:
      - '${FRONTEND_PORT:-4321}:80' # Frontend serves on port 80 internally
    depends_on:
      - chatterbox-tts
    restart: unless-stopped
